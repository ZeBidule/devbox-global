#!/bin/bash

# shellcheck disable=SC2034
plugins=(git docker kubectl terraform aws colored-man-pages zsh-autosuggestions)

# shellcheck disable=SC1091
source "$ZSH/oh-my-zsh.sh"

fpath=($ZSH/custom/completions $fpath)

# #####################################
# Load devbox tools
# #####################################
eval "$(devbox global shellenv --init-hook)"
if [[ -e "/home/antoine/.nix-profile/etc/profile.d/nix.sh" ]]
then
  # shellcheck disable=SC1091
  . "/home/antoine/.nix-profile/etc/profile.d/nix.sh"
fi # added by Nix installer

devbox completion zsh > "${fpath[1]}/_devbox"

# #####################################
# Load aliases
# #####################################
# shellcheck disable=SC1091
. "$HOME/.zsh_aliases"

# #####################################
# Load fzf completion
# #####################################
if [[ -n "${commands[fzf-share]}" ]]
then
  # shellcheck disable=SC1091
  source "$(fzf-share)/key-bindings.zsh"
  # shellcheck disable=SC1091
  source "$(fzf-share)/completion.zsh"
fi

# ############################################
# Prompt
# ############################################
eval "$(starship init zsh)"


# fix ansible launch
# export LC_ALL="C.UTF-8"

# ############################################
# Commands to launch at each terminal start
# ############################################

if [[ $(systemctl is-active cntlm.service) != "active" || $(systemctl is-active redsocks.service) != "active" ]]
then
  proxy_start
fi
# if [[ $(systemctl is-active cntlm.service) == "active" || $(systemctl is-active redsocks.service) == "active" ]]
# then
#   proxy_stop
# fi

if [[ ! -f "$HOME/.last_update" || $(cat "$HOME/.last_update") -lt $(date -d '1 week ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_update"
  update
fi

if [[ ! -f "$HOME/.last_free_space" || $(cat "$HOME/.last_free_space") -lt $(date -d '1 week ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_free_space"
  free_space
fi

if [[ ! -f "$HOME/.last_deleteOldBranches" || $(cat "$HOME/.last_deleteOldBranches") -lt $(date -d '4 week ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_deleteOldBranches"
  SILENT=1 deleteOldBranchesInEachRepo
fi

if ! aws sts get-caller-identity --profile sfa > /dev/null 2>&1
then
  sfa
fi
