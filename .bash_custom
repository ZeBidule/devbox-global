#!/bin/bash

# #####################################
# Load devbox tools
# #####################################
eval "$(devbox global shellenv --init-hook)"
if [[ -e "/home/antoine/.nix-profile/etc/profile.d/nix.sh" ]]
then
  # shellcheck disable=SC1091
  . "/home/antoine/.nix-profile/etc/profile.d/nix.sh"
fi # added by Nix installer

# #####################################
# Load blesh (must be loaded early)
# #####################################
BLESH_PATH=$(ls -d /nix/store/*blesh*/share/blesh/ble.sh 2>/dev/null | head -1)
# shellcheck disable=SC1090
[[ -n "$BLESH_PATH" ]] && source "$BLESH_PATH"

# #####################################
# Load environment variables
# #####################################
# shellcheck disable=SC1091
. "$HOME/.bash_env"

# #####################################
# Load aliases
# #####################################
# shellcheck disable=SC1091
. "$HOME/.bash_aliases"

# #####################################
# Load fzf completion
# #####################################
# Set up fzf key bindings and fuzzy completion
eval "$(fzf --bash)"
# shellcheck disable=SC1091
source "$(fzf-share)/key-bindings.bash"
# shellcheck disable=SC1091
source "$(fzf-share)/completion.bash"

# ############################################
# Prompt
# ############################################
eval "$(starship init bash)"


# fix ansible launch
# export LC_ALL="C.UTF-8"

# ############################################
# Commands to launch at each terminal start
# ############################################

if [[ $(systemctl is-active cntlm) != "active" || $(systemctl is-active gost) != "active" || $(systemctl is-active wsl-vpnkit) != "active" ]]
then
  proxy_start
fi

if [[ ! -f "$HOME/.last_update" || $(cat "$HOME/.last_update") -lt $(date -d '1 week ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_update"
  update
fi

if [[ ! -f "$HOME/.last_backup" || $(cat "$HOME/.last_backup") -lt $(date -d '1 day ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_backup"
  backup
fi

if [[ ! -f "$HOME/.last_free_space" || $(cat "$HOME/.last_free_space") -lt $(date -d '1 week ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_free_space"
  free_space
fi

if [[ ! -f "$HOME/.last_deleteOldBranches" || $(cat "$HOME/.last_deleteOldBranches") -lt $(date -d '4 week ago' '+%s') ]]
then
  date '+%s' > "$HOME/.last_deleteOldBranches"
  SILENT=1 deleteOldBranchesInEachRepo
fi

if ! aws sts get-caller-identity --profile sfa > /dev/null 2>&1
then
  sfa
fi
